<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Szczeg√≥≈Çy zadania</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 5px;
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<label for="duration">‚è± Czas trwania (h):</label>
<input type="number" id="duration" />

<label for="description">üìù Opis zadania:</label>
<textarea id="description" rows="3"></textarea>

<p style="color:green;" id="status"></p>

<script src="https://p.trellocdn.com/power-up.min.js"></script>
<script>
  const t = TrelloPowerUp.iframe();

  // Wczytaj dane z karty (private do karty i u≈ºytkownika lub shared)
  t.get('card', 'shared', 'customData').then(data => {
    if (data) {
      document.getElementById('duration').value = data.duration || '';
      document.getElementById('description').value = data.description || '';
    }
  });

  function saveAndSend() {
    const duration = document.getElementById('duration').value;
    const description = document.getElementById('description').value;

    const customData = {
      duration,
      description,
      updatedAt: new Date().toISOString()
    };

    // Zapisz lokalnie w Trello Power-Upie (na karcie)
    t.set('card', 'shared', { customData }).then(() => {
      document.getElementById('status').textContent = "üíæ Zapisano";

      // Wy≈õlij do n8n
      Promise.all([
        t.card('id', 'name', 'shortLink'),
        t.member('username')
      ]).then(([card, user]) => {
        return fetch('https://n8n.cosmicweb.cloud/webhook-test/trello-button', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            card,
            user,
            timestamp: new Date().toISOString(),
            ...customData
          })
        });
      });
    });
  }

  // Obs≈Çuga autozapisu
  document.getElementById('duration').addEventListener('change', saveAndSend);
  document.getElementById('description').addEventListener('change', saveAndSend);

  t.sizeTo(document.body).done();
</script>
</body>
</html>
