<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Start Workflow Popup</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 10px;
        }
        button {
            display: block;
            margin-bottom: 6px;
            padding: 6px;
            width: 100%;
        }
        #buttons {
            display: none;
        }
        #form-section {
            margin-top: 10px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            margin-bottom: 8px;
        }
        #back {
            display: none; /* ukryty na start */
        }
    </style>
</head>
<body>
<script src="https://p.trellocdn.com/power-up.min.js"></script>

<button id="start-main">üöÄ Start Workflow</button>

<div id="buttons">
    <button onclick="startAction('exeros-api')">‚ñ∂ Start exeros-api</button>
    <button onclick="startAction('exeros-panel')">‚ñ∂ Start exeros-panel</button>
    <button onclick="startAction('exeros-api-caching-proxy')">‚ñ∂ Start exeros-api-caching-proxy</button>
    <button onclick="startAction('exeros-web-companion')">‚ñ∂ Start exeros-web-companion</button>
    <button id="back">‚Üê Wr√≥ƒá</button>
</div>

<div id="form-section">
    <label for="task-desc">Opis zadania:</label>
    <textarea id="task-desc" rows="3" placeholder="Wpisz opis..."></textarea>

    <label for="start-date">Data rozpoczƒôcia:</label>
    <input type="datetime-local" id="start-date" />

    <button id="submit-details">üíæ Zatwierd≈∫ dane</button>
</div>

<script>
    const t = TrelloPowerUp.iframe();

    // Funkcja ≈ÇadujƒÖca dane z storage
    function loadDetails() {
        t.get('card', 'shared', 'taskDetails')
            .then(data => {
                if (data) {
                    document.getElementById('task-desc').value = data.description || '';
                    document.getElementById('start-date').value = data.start_date || '';
                }
            });
    }

    // Obs≈Çuga zapisu danych formularza
    document.getElementById('submit-details').addEventListener('click', function () {
        const opis = document.getElementById('task-desc').value;
        const data = document.getElementById('start-date').value;

        if (!opis || !data) {
            alert('Uzupe≈Çnij oba pola.');
            return;
        }

        t.set('card', 'shared', 'taskDetails', {
            description: opis,
            start_date: data
        }).then(() => {
            alert('Dane zosta≈Çy zapisane lokalnie w Power-Upie.');
        });
    });

    // Pokazywanie przycisk√≥w startowych po klikniƒôciu "Start Workflow"
    document.getElementById('start-main').addEventListener('click', function () {
        document.getElementById('buttons').style.display = 'block';
        document.getElementById('back').style.display = 'block';
        this.style.display = 'none';

        // Opcjonalnie ukryƒá formularz je≈õli chcesz
        // document.getElementById('form-section').style.display = 'none';

        t.sizeTo(300).done(); // dopasuj wysoko≈õƒá iframe do nowego widoku
    });

    // Obs≈Çuga przycisku "Wr√≥ƒá"
    document.getElementById('back').addEventListener('click', function () {
        document.getElementById('buttons').style.display = 'none';
        this.style.display = 'none';
        document.getElementById('start-main').style.display = 'block';

        // Poka≈º formularz (je≈õli ukrywa≈Çe≈õ)
        // document.getElementById('form-section').style.display = 'block';

        t.sizeTo(250).done(); // przywr√≥ƒá rozmiar iframe do oryginalnego (formularz)
    });

    // Funkcja wysy≈ÇajƒÖca dane po klikniƒôciu jednego z 4 startowych przycisk√≥w
    function startAction(actionName) {
        Promise.all([
            t.card('id', 'name', 'shortLink'),
            t.member('username')
        ]).then(([card, user]) => {
            return fetch('https://n8n.cosmicweb.cloud/webhook-test/trello-button', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: actionName,
                    card: card,
                    user: user,
                    timestamp: new Date().toISOString()
                })
            });
        }).then(() => {
            t.closeModal();
        });
    }

    // Za≈Çaduj dane przy starcie iframe
    loadDetails();

    // Ustaw poczƒÖtkowy rozmiar iframe
    t.sizeTo(250).done();
</script>
</body>
</html>
